# TrustHub

Центральный контур доверия на inimtaic. назначение: PKI + enrollment + авторизация + биллинг для облачной коммерческой версии.

## 1) базовые принципы

* **идентичность = сертификат + mTLS везде**: каждый хост, агент и «скилл/сценарий-сервис» общается только по mTLS. никаких паролей.
* **два домена доверия (trust domains)**:

  1. центральный: `adaos://core` (внутренняя PKI для всей инсталляции/организации);
  2. пользовательский: `adaos://user-{fingerprint}` (телефон как корень локальной подсети).
     агенты признают оба домена по политике (см. ниже).
* **короткоживущие сертификаты** + автоматическое продление. приоритет — избегать CRL/OCSP в рантайме.
* **разделение authN/authZ**:

  * authN — mTLS + «кто ты?» (SPIFFE-подобный ID).
  * authZ — политики OPA/Rego или Cedar, + при необходимости «capabilities» (macaroons) для делегирования прав на короткое время.

## 2) PKI и идентификаторы

* **корневые CA:**

  * CoreRootCA (офис/сервер): офлайн корень → online IntermediateCA(Core).
  * UserRootCA (телефон): создаётся при первом запуске приложения, ключ хранится в hardware keystore (Android StrongBox/TEE, iOS Secure Enclave).
* **имена (SPIFFE-стиль):**

  * хост: `spiffe://adaos/core/host/{fqdn}`
  * агент: `spiffe://adaos/core/agent/{host}/{agent_id}`
  * пользовательская подсеть: `spiffe://adaos/user-{fp}/agent/{device}/{agent_id}`
* **федерация доверия**: агенты держат список доверенных TD (trust domains) и политики сопоставления ролей. можно включать/отключать доверие к `user-{fp}` в любой момент.

## 3) безопасные каналы

* **внутрисетевой оверлей:** WireGuard для p2p/mesh между хостами и агентами (простая NAT-traversion, высокая производительность). ключи WG раздаём как «секрет» через mTLS-канал; по желанию подписываем «WG-сертификат» нашей PKI.
* **API/веб-шлюзы:** только mTLS на вход, client cert → SPIFFE ID → маппинг на субъекта (user/device/agent). поверх — короткие OAuth2/OIDC JWT-токены для сценариев и UI (mint от имени client-cert субъекта).
* **p2p на мобильных/edge:** при недоступности оверлея допускаем прямой Noise-ручей (Noise XX/IK) с ключами из PKI.

## 4) потоки инициализации (enrollment)

### А. телефон-первый (локальная подсеть от пользователя)

1. приложение на телефоне создаёт **UserRootCA**.
2. пользователь «добавляет устройство»: QR-кодом/в NFC передаётся **одноразовый bootstrap-токен** и публичный ключ устройства.
3. телефон как CA подписывает CSR устройства → выдаёт короткоживущий **leaf-сертификат** (`spiffe://adaos/user-{fp}/…`) и параметры WireGuard.
4. устройства уже могут **между собой** общаться по mTLS/WG без участия центра.
5. (опционально) федерация с центральным доменом: центр добавляет `user-{fp}` в доверенные, а телефон может запросить у центра **кросс-подпись** промежуточного CA с **NameConstraints** (чтобы ограничить область действий).

### Б. центр-первый (организация/кампус)

1. админ выпускает **bootstrap-токен** из центра (в т.ч. зашитый в инсталлятор/образ).
2. агент поднимается, генерит keypair в secure storage, шлёт CSR по mTLS (EST/ACME-подобный протокол) → получает **Core-сертификат**.
3. при появлении пользователя можно привязать устройство к его `user-{fp}` (двойная принадлежность через **двойной leaf** или **два SVID**).

## 5) авторизация (authZ)

* **политики на OPA (Rego)** или **Cedar**:

  * субъекты: {user, device, agent, skill, scenario, org-role}.
  * атрибуты контекста: ["настройки подсети", "скрипт/сценарий", "ресурс", "операция", "время", "местоположение"].
* **capabilities/macaroons** для делегирования: телефон/центр может выдать **временной capability-токен** со «стеснениями» (attenuation): ресурс = камера/датчик; действие = read; ttl = 5 минут; audience = spiffe ID. эти токены подписаны и проверяются оффлайн.
* **паттерн «session-caps» для сценариев**: при старте сценария оркестратор мятит пучок одноразовых прав для нужных агентов/скиллов, которые живут ровно столько, сколько длится сессия.

## 6) ротация, отзыв, инциденты

* **short-lived**: 12–72 часа для устройств/агентов, 5–15 минут для session-caps/JWT.
* **silent-renew** за T/3 до истечения.
* **отзыв**: вместо тяжёлых CRL — **push-denylist** (подписанный список отозванных сертов/ключей), распространяемый через контрольный канал; агенты кэшируют и проверяют перед установлением сессии. критические случаи — мгновенный «kill-switch» по ID.
* **компрометация телефона**: СRA (central revocation authority) отзывает доверие к `user-{fp}` домену и все его кросс-подписи. при восстановлении — новый fp → новая федерация.

## 7) логирование и прозрачность

* **протокол выдачи/отзыва** пишем в **append-only журнал** (меркл-дерево): кто, кому, когда, какой DN/SPIFFE, какие ограничения. это облегчает аудит и форензику.
* **все mTLS рукопожатия** логируются с привязкой к policy-решениям (кто что запросил и почему разрешено/запрещено).

## 8) пользователь без паролей

* **вход в UI/CLI**: WebAuthn/Passkeys (телефон как аутентификатор).
* **подписание админ-действий**: подтверждение на телефоне (CTAP2) + привязка к его `user-{fp}`.
* **SSH/админка**: только **короткие SSH-серты** от нашей PKI (никаких ключей/паролей на дисках).

## 9) секреты и поставка артефактов

* **секрет-менеджмент**: шифруем секреты под публичный ключ целевого агента (или под его SPIFFE-аудиторию) и доставляем через mTLS; расшифровка — только в TEE/keystore.
* **подпись «скиллов/сценариев» и обновлений**: цепочка доверия как в TUF/Notary-v2 — устройство устанавливает только подписанные сборки с действительными ключами выпуска.

## 10) практическая реализация (MVP → масштаб)

**MVP (2–4 недели):**

* развернуть внутренний CA (подойдёт step-ca/CFSSL/Vault PKI).
* mTLS для всех RPC (FastAPI/gRPC) + WireGuard-оверлей.
* «телефон как CA» в простом виде: локальная генерация CA + подпись CSR через QR-обмен (одноразовый токен).
* базовая авторизация через OPA: 3–5 политик (чит/запись датчиков, доступ к медиа, запуск навыков).
* короткоживущие серты (48h) + автопродление.

### ключевые решения

* **PKI:** офлайн `RootCA` → per-tenant `IntermediateCA` в HSM (YubiHSM/CloudHSM).
* **идентичности (SPIFFE):** `spiffe://adaos/{tenant}/host/{fqdn}`, `.../agent/{host}/{agent_id}`, `.../svc/{skill}`.
* **каналы:** везде mTLS; поверх — короткие OAuth2/OIDC токены для UI/API.
* **сертификаты:** short-lived (24–72h), silent-renew; отзыв — signed denylist + мгновенный kill-switch.
* **2FA строго обязательно** при первичном выпуске и при повышении привилегий (WebAuthn/Passkeys как дефолт, TOTP — бэкап).
* **никаких user-root CA**. телефон используется для подтверждений (CTAP2/Push), а не для подписи.

### потоки инициализации (enrollment)

1. **создание тенанта (org):**

   * админ в облаке → создаётся `IntermediateCA` (HSM), политики NameConstraints для `spiffe://adaos/{tenant}/…`.
2. **регистрация хоста по QR:**

   * на хосте запускается «bootstrap агент» → показывает **CSR-фингерпринт/nonce** (или выводит URL с кэптом).
   * админ в консоли сканирует QR → **2FA подтверждение** → облако выпускает **одноразовый enrollment-токен (JTI, 5 мин)**, привязанный к tenant/nonce.
   * хост по EST/ACME-подобному API: `POST /v1/csr` с токеном + CSR → **проверка 2FA-сессии** → выдача первого **host-серта**.
3. **агенты/сервисы на хосте:**

   * получают SVID через локальный NodeAgent (SPIRE-node-attestor «token») → короткие leaf-серты для процессов.
4. **ротация:**

   * за T/3 до истечения NodeAgent обновляет SVID по mTLS без участия человека. повышенные роли требуют повторного 2FA.

### авторизация

* **политики OPA/Cedar** (тенант-скоуп): субъект = {host/agent/user/role}, ресурс = {skill, media, sensor, secret}, действие = {read/write/exec/register}, контекст = {время, место, план}.
* **делегирование внутрь сценариев:** capability-токены (macaroons) с ограничениями (ресурс/ttl/audience), выдаёт оркестратор по mTLS.

### коммерциализация (multi-tenant SaaS)

* **изоляция тенантов:** отдельные IntermediateCA + отдельные policy-bundles + namespace в метриках/логах.
* **тарифы:** лимиты на *кол-во хостов/агентов, выпусков сертов/сутки, секретов, throughput API*.
* **метринг:** event-шина (Kafka/NATS) → `billing.issuance.count`, `mTLS.sessions`, `policy.decisions`, `wg.bytes`.
* **биллинг/инвойсинг:** usage-based; webhooks для сторонних платёжек.
* **SLA/региональность:** pin-по-регионам, отдельные корни per-region, экспорт-контроль ключей.

### API TrustHub (черновик)

* `POST /v1/tenants` — создать тенант (роль: супер-админ).
* `POST /v1/enroll/token` — начать 2FA-сессию, вернуть enrollment-токен (только через UI с WebAuthn).
* `POST /v1/csr` — обмен CSR→сертификат (проверяет JTI + 2FA-сессию).
* `POST /v1/rotate` — ротация по действующему mTLS.
* `POST /v1/revoke` — отзыв (host/agent/svid).
* `GET /v1/denylist` — подписанный список отозванных.
* `POST /v1/policy` — загрузка пакета политик (per-tenant).
* `GET /v1/usage` — метрики для биллинга.

### профили сертификатов (X.509)

* **SAN:** SPIFFE URI + DNS (для host), при необходимости IP.
* **KU/EKU:** DigitalSignature, KeyEncipherment; EKU: ClientAuth, ServerAuth.
* **NameConstraints** на IntermediateCA: разрешить только `spiffe://adaos/{tenant}/…`.
* **alg:** ECDSA P-256/Ed25519; серты ≤72h; CRL off, OCSP off.

### CLI/опыт

* `adaos trust enroll --qr` (bootstrap показывает QR)
* `adaos trust status` (проверка срока SVID/host-серта)
* `adaos trust revoke --host <id>`
* `adaos policy push --file policy.rego --tenant X`

### хранение и секреты

* **ключи host/agent** в OS keystore/TPM; для мобильных — StrongBox/Secure Enclave.
* **секреты** доставляются шифром на SPIFFE-аудиторию (recipient-wrapped), расшифровка только внутри TEE/keystore.

### журнал прозрачности

* append-only (меркл-лог) всех операций: выпуск/отзыв/ротация/решения policy. экспорт в SIEM.

### миграция от «двух корней» к «одному»

* отключаем user-root, оставляем только WebAuthn на телефоне.
* принудительная ротация всех сертов под новым IntermediateCA.
* политика запрета соединений из недоверенных TD.

---

## MVP-план (2–3 недели)

1. **PKI ядро:** step-ca/CFSSL + офлайн Root, HSM-backed Intermediate (один tenant для начала).
2. **enrollment с 2FA:** UI с WebAuthn → `/v1/enroll/token` → `/v1/csr` (первичный выпуск).
3. **SPIRE (или лёгкий node-agent):** выдача SVID для процессов, короткие серты + авто-ротация.
4. **mTLS-обвязка** для AdaOS RPC + WireGuard-оверлей по сертам.
5. **OPA-пакет политик** для базовых ресурсов.
6. **метринг** выпусков и сессий → счётчики для биллинга.
7. **denylist API** и kill-switch.
