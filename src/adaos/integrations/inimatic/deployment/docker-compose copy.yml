networks:
  proxy:
    name: inimatic_proxy
volumes:
  nginx_conf:
    name: inimatic_nginx_conf
  nginx_vhost:
    name: inimatic_nginx_vhost
  nginx_html:
    name: inimatic_nginx_html
  nginx_certs:
    name: inimatic_nginx_certs

services:
  reverse-proxy:
    image: nginxproxy/nginx-proxy:alpine
    container_name: reverse-proxy
    restart: unless-stopped
    ports: ["80:80", "443:443"]
    networks: [proxy]
    environment:
      SSL_POLICY: Mozilla-Modern
      TRUST_DOWNSTREAM_PROXY: "false"
    volumes:
      - /var/run/docker.sock:/tmp/docker.sock:ro
      - nginx_conf:/etc/nginx/conf.d
      - /opt/inimatic/vhost.d:/etc/nginx/vhost.d:ro
      - nginx_html:/usr/share/nginx/html
      - nginx_certs:/etc/nginx/certs
      - /opt/inimatic/vhost:/etc/nginx/vhost.user.d:ro
      - /opt/inimatic/secrets/ca/ca.crt:/etc/nginx/certs/adaos_ca.pem:ro
    labels:
      - com.github.nginx-proxy.nginx=true

  acme:
    image: nginxproxy/acme-companion:latest
    container_name: acme
    restart: unless-stopped
    networks: [proxy]
    depends_on: [reverse-proxy]
    env_file:
      - /opt/inimatic/.env
    environment:
      DEFAULT_EMAIL: "connect@stipot.com"
      NGINX_PROXY_CONTAINER: reverse-proxy
      # ACME_CA_URI: https://acme-staging-v02.api.letsencrypt.org/directory
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - nginx_conf:/etc/nginx/conf.d
      - nginx_vhost:/etc/nginx/vhost.d
      - nginx_html:/usr/share/nginx/html
      - nginx_certs:/etc/nginx/certs

  redis:
    image: redis:7-alpine
    command: ["redis-server"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks: [proxy]

  frontend_a:
    image: ghcr.io/stipot-com/inimatic-frontend:latest
    restart: unless-stopped
    expose: ["8080"]
    networks: [proxy]
    environment:
      VIRTUAL_HOST: app.inimatic.com, v1.app.inimatic.com
      VIRTUAL_PORT: "8080"
      LETSENCRYPT_HOST: app.inimatic.com, v1.app.inimatic.com
      LETSENCRYPT_EMAIL: connect@stipot.com
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://localhost:8080/ >/dev/null || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
    labels:
      - com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true

  backend_a:
    image: ghcr.io/stipot-com/inimatic-backend:latest
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    expose: ["3030"]
    networks: [proxy]
    env_file:
      - /opt/inimatic/.env
    environment:
      VIRTUAL_HOST: api.inimatic.com
      VIRTUAL_PORT: "3030"
      VIRTUAL_PROTO: "https"
      LETSENCRYPT_HOST: api.inimatic.com
      LETSENCRYPT_EMAIL: connect@stipot.com
      GH_APP_PRIVATE_KEY_FILE: /run/inimatic/secrets/github-app.pem
      CA_KEY_PEM_FILE: /run/inimatic/secrets/ca/ca.key
      CA_CERT_PEM_FILE: /run/inimatic/secrets/ca/ca.crt
      # важно: одной строкой, без > или |
      GIT_SSH_COMMAND: "ssh -i /run/inimatic/ssh/forge_ssh_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes"
    volumes:
      - /opt/inimatic/secrets:/run/inimatic/secrets:ro
      # готовые файлы для git/ssh
      - /opt/inimatic/runtime/ssh/forge_ssh_key:/run/inimatic/ssh/forge_ssh_key:ro
      - /opt/inimatic/runtime/ssh/known_hosts:/root/.ssh/known_hosts:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -kfsS https://localhost:3030/healthz >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 60s

  frontend_b:
    image: ghcr.io/stipot-com/inimatic-frontend:latest
    restart: unless-stopped
    expose: ["8080"]
    networks: [proxy]
    environment:
      VIRTUAL_HOST: app.inimatic.com, v1.app.inimatic.com
      VIRTUAL_PORT: "8080"
      LETSENCRYPT_HOST: app.inimatic.com, v1.app.inimatic.com
      LETSENCRYPT_EMAIL: connect@stipot.com
    healthcheck:
      test:
        ["CMD-SHELL", "curl -fsS http://localhost:8080/ >/dev/null || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
    labels:
      - com.github.jrcs.letsencrypt_nginx_proxy_companion.nginx_proxy=true

  backend_b:
    image: ghcr.io/stipot-com/inimatic-backend:latest
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    expose: ["3030"]
    networks: [proxy]
    env_file:
      - /opt/inimatic/.env
    environment:
      VIRTUAL_HOST: api.inimatic.com
      VIRTUAL_PORT: "3030"
      VIRTUAL_PROTO: "https"
      LETSENCRYPT_HOST: api.inimatic.com
      LETSENCRYPT_EMAIL: connect@stipot.com
      GH_APP_PRIVATE_KEY_FILE: /run/inimatic/secrets/github-app.pem
      CA_KEY_PEM_FILE: /run/inimatic/secrets/ca/ca.key
      CA_CERT_PEM_FILE: /run/inimatic/secrets/ca/ca.crt
      GIT_SSH_COMMAND: "ssh -i /run/inimatic/ssh/forge_ssh_key -o IdentitiesOnly=yes -o StrictHostKeyChecking=yes"
    volumes:
      - /opt/inimatic/secrets:/run/inimatic/secrets:ro
      - /opt/inimatic/runtime/ssh/forge_ssh_key:/run/inimatic/ssh/forge_ssh_key:ro
      - /opt/inimatic/runtime/ssh/known_hosts:/root/.ssh/known_hosts:ro
    healthcheck:
      test:
        [
          "CMD-SHELL",
          "curl -kfsS https://localhost:3030/healthz >/dev/null || exit 1",
        ]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 60s

  nats:
    image: nats:2.10-alpine
    command: ["-js", "-sd", "/data"]
    restart: unless-stopped
    ports: ["4222:4222"]
    networks: [proxy]
    volumes:
      - nats_data:/data

  api:
    image: python:3.11-slim
    working_dir: /app
    command: ["bash", "-lc", "pip install --no-cache-dir . && adaos api serve --host 0.0.0.0 --port 8000"]
    volumes:
      - ../../../..:/app:rw
    environment:
      IO_BUS_KIND: ${IO_BUS_KIND:-nats}
      NATS_URL: ${NATS_URL:-nats://nats:4222}
      TG_BOT_TOKEN: ${TG_BOT_TOKEN}
      TG_SECRET_TOKEN: ${TG_SECRET_TOKEN}
      FILES_TMP_DIR: ${FILES_TMP_DIR:-/data/tmp}
      ROUTE_RULES_PATH: ${ROUTE_RULES_PATH:-/data/route_rules.yaml}
      DEFAULT_HUB: ${DEFAULT_HUB:-hub-a}
    depends_on:
      - nats
    networks: [proxy]

  hub-mock:
    image: python:3.11-slim
    working_dir: /app
    command: ["bash", "-lc", "pip install --no-cache-dir nats-py httpx pyyaml && python src/adaos/services/testing/hub_mock.py"]
    volumes:
      - ../../../..:/app:rw
    environment:
      NATS_URL: ${NATS_URL:-nats://nats:4222}
      DEFAULT_HUB: ${DEFAULT_HUB:-hub-a}
      BOT_ID: ${BOT_ID:-main-bot}
    depends_on:
      - nats
    networks: [proxy]

volumes:
  nats_data:
    name: inimatic_nats_data
