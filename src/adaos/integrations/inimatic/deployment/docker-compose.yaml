version: "3.9"

services:
  redis:
    image: redis:7-alpine
    command: ["redis-server"]
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 5s
    networks:
      - internal

  traefik:
    profiles: ["prod"]
    image: traefik:v3.1
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=proxy
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.web.http.redirections.entryPoint.to=websecure
      - --entrypoints.web.http.redirections.entryPoint.scheme=https
      - --certificatesresolvers.le.acme.email=${LE_EMAIL}
      - --certificatesresolvers.le.acme.storage=/letsencrypt/acme.json
      - --certificatesresolvers.le.acme.httpchallenge.entrypoint=web
      - --api.dashboard=true
      - --accesslog=true
      - --accesslog.format=json
      - --log.format=json
      - --log.level=INFO
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
    networks:
      - proxy

  backend:
    profiles: ["prod"]
    image: ghcr.io/stipot-com/inimatic-backend:latest
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    expose:
      - "3030"
    environment:
      PORT: "3030"
      PRODUCTION: ${PRODUCTION:-1}
      FORGE_GIT_URL: ${FORGE_GIT_URL}
      FORGE_WORKDIR: ${FORGE_WORKDIR}
      FORGE_GIT_AUTHOR_NAME: ${FORGE_GIT_AUTHOR_NAME}
      FORGE_GIT_AUTHOR_EMAIL: ${FORGE_GIT_AUTHOR_EMAIL}
      CA_KEY_PEM_FILE: /run/secrets/ca_key
      CA_CERT_PEM_FILE: /run/secrets/ca_crt
      TLS_KEY_PEM_FILE: /run/secrets/tls_key
      TLS_CERT_PEM_FILE: /run/secrets/tls_crt
      ROOT_TOKEN: ${ROOT_TOKEN:-}
      FORGE_SSH_KEY: ${FORGE_SSH_KEY:-}
    secrets:
      - ca_key
      - ca_crt
      - tls_key
      - tls_crt
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3030/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
    labels:
      - traefik.enable=true
      - traefik.http.routers.api.rule=Host(`api.inimatic.com`)
      - traefik.http.routers.api.entrypoints=websecure
      - traefik.http.routers.api.tls.certresolver=le
      - traefik.http.services.api.loadbalancer.server.port=3030
      - traefik.http.routers.api.middlewares=api-sec@docker,api-rl@docker
      - traefik.http.middlewares.api-sec.headers.stsSeconds=63072000
      - traefik.http.middlewares.api-sec.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.api-sec.headers.stsPreload=true
      - traefik.http.middlewares.api-sec.headers.contentTypeNosniff=true
      - traefik.http.middlewares.api-sec.headers.browserXssFilter=true
      - traefik.http.middlewares.api-sec.headers.customFrameOptionsValue=SAMEORIGIN
      - traefik.http.middlewares.api-sec.headers.referrerPolicy=no-referrer
      - traefik.http.middlewares.api-rl.ratelimit.average=20
      - traefik.http.middlewares.api-rl.ratelimit.burst=40
    networks:
      - internal
      - proxy

  frontend:
    profiles: ["prod"]
    image: ghcr.io/stipot-com/inimatic-frontend:latest
    restart: unless-stopped
    depends_on:
      backend:
        condition: service_healthy
    expose:
      - "8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/ || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
    labels:
      - traefik.enable=true
      - traefik.http.routers.app.rule=Host(`app.inimatic.com`)
      - traefik.http.routers.app.entrypoints=websecure
      - traefik.http.routers.app.tls.certresolver=le
      - traefik.http.services.app.loadbalancer.server.port=8080
      - traefik.http.routers.app.middlewares=app-sec@docker
      - traefik.http.middlewares.app-sec.headers.stsSeconds=63072000
      - traefik.http.middlewares.app-sec.headers.stsIncludeSubdomains=true
      - traefik.http.middlewares.app-sec.headers.stsPreload=true
      - traefik.http.middlewares.app-sec.headers.contentTypeNosniff=true
      - traefik.http.middlewares.app-sec.headers.browserXssFilter=true
      - traefik.http.middlewares.app-sec.headers.customFrameOptionsValue=SAMEORIGIN
      - traefik.http.middlewares.app-sec.headers.referrerPolicy=no-referrer
    networks:
      - proxy

  backend-dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: ./deployment/backend.Dockerfile
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_healthy
    environment:
      PORT: "3030"
      PRODUCTION: ${PRODUCTION:-1}
      FORGE_GIT_URL: ${FORGE_GIT_URL}
      FORGE_WORKDIR: ${FORGE_WORKDIR}
      FORGE_GIT_AUTHOR_NAME: ${FORGE_GIT_AUTHOR_NAME}
      FORGE_GIT_AUTHOR_EMAIL: ${FORGE_GIT_AUTHOR_EMAIL}
      CA_KEY_PEM_FILE: /secrets/dev/ca.key
      CA_CERT_PEM_FILE: /secrets/dev/ca.crt
      TLS_KEY_PEM_FILE: /secrets/dev/tls.key
      TLS_CERT_PEM_FILE: /secrets/dev/tls.crt
      ROOT_TOKEN: ${ROOT_TOKEN:-}
      FORGE_SSH_KEY: ${FORGE_SSH_KEY:-}
    volumes:
      - type: bind
        source: ${DEV_CA_KEY_FILE:-./deployment/dev-secrets/ca.key}
        target: /secrets/dev/ca.key
        read_only: true
      - type: bind
        source: ${DEV_CA_CERT_FILE:-./deployment/dev-secrets/ca.crt}
        target: /secrets/dev/ca.crt
        read_only: true
      - type: bind
        source: ${DEV_TLS_KEY_FILE:-./deployment/dev-secrets/server.key}
        target: /secrets/dev/tls.key
        read_only: true
      - type: bind
        source: ${DEV_TLS_CERT_FILE:-./deployment/dev-secrets/server.crt}
        target: /secrets/dev/tls.crt
        read_only: true
    ports:
      - "3030:3030"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:3030/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
    networks:
      - internal

  frontend-dev:
    profiles: ["dev"]
    build:
      context: .
      dockerfile: ./deployment/frontend.Dockerfile
      args:
        BUILD_SCRIPT: ${FRONTEND_BUILD_SCRIPT:-build}
    restart: unless-stopped
    depends_on:
      backend-dev:
        condition: service_healthy
    environment:
      BUILD_SCRIPT: ${FRONTEND_BUILD_SCRIPT:-build}
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8080/ || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10
      start_period: 20s
    networks:
      - internal

secrets:
  ca_key:
    file: ./deployment/secrets/ca.key
  ca_crt:
    file: ./deployment/secrets/ca.crt
  tls_key:
    file: ./deployment/secrets/server.key
  tls_crt:
    file: ./deployment/secrets/server.crt

volumes:
  traefik_letsencrypt: {}

networks:
  proxy:
    driver: bridge
  internal:
    driver: bridge
