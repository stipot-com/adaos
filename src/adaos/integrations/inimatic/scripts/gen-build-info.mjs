import fs from 'node:fs'
import path from 'node:path'

function readJson(p) {
  return JSON.parse(fs.readFileSync(p, 'utf8'))
}

function env(name) {
  const v = process.env[name]
  return typeof v === 'string' ? v.trim() : ''
}

function normalizeBuildId(id) {
  return String(id || '')
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^a-zA-Z0-9._-]/g, '')
}

const repoRoot = process.cwd()
const pkg = readJson(path.join(repoRoot, 'package.json'))

const pkgVersion = String(pkg.version || '0.0.0')
const explicit = normalizeBuildId(env('BUILD_VERSION'))
const gha = (() => {
  const sha = env('GITHUB_SHA')
  if (!sha) return ''
  const run = env('GITHUB_RUN_NUMBER')
  const short = sha.slice(0, 7)
  return normalizeBuildId(`gh-${run || '0'}-${short}`)
})()

const buildId = explicit || gha || normalizeBuildId(`local-${Date.now()}`)
const buildVersion = `${pkgVersion}+${buildId}`
const buildTime = new Date().toISOString()

const outFile = path.join(repoRoot, 'src', 'environments', 'build.prod.ts')
const content =
  `// Auto-generated by scripts/gen-build-info.mjs\n` +
  `export const buildId: string = ${JSON.stringify(buildId)}\n` +
  `export const buildVersion: string = ${JSON.stringify(buildVersion)}\n` +
  `export const buildTime: string = ${JSON.stringify(buildTime)}\n`

fs.mkdirSync(path.dirname(outFile), { recursive: true })
fs.writeFileSync(outFile, content, 'utf8')
console.log(`[build-info] wrote ${path.relative(repoRoot, outFile)}: ${buildVersion}`)
